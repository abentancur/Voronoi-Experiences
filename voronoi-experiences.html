<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
        </style>
    </head>
    <body>
        <div id="container"> </div>

        <script src="http://www.html5canvastutorials.com/libraries/three.min.js"></script>
        <script defer="defer">

            document.addEventListener('mousedown', onDocumentMouseDown, false);
            document.addEventListener("keydown", onDocumentKeyPress, false);
            //current path type for new points to follow
            var currentPathtype = "circle";
            //a list of all the voronoi cells
            var voronoiMap = [];

            // this function is executed on each animation frame
            function animate(){
                // update all the cells in the voronoi map
                var timer = new Date().getTime() * 0.0005;
                for (cell of voronoiMap){
                    cell.update(timer);
                }
                

                // render
                renderer.render(scene, camera);

                // request new frame
                requestAnimationFrame(function(){
                    animate();
                });
            }

            // renderer
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // camera
            var camera = new THREE.OrthographicCamera(0, window.innerWidth, window.innerHeight, 0, 1, 1000);
            camera.position.z = 700;

            // scene
            var scene = new THREE.Scene();

            // start animation
            animate();

            function onDocumentMouseDown(event) {
                var cell = new voronoiCell(currentPathtype, event.clientX, window.innerHeight - event.clientY);
                scene.add(cell.sphere);
                scene.add(cell.cone);
                voronoiMap.push(cell);
    
            }
            function onDocumentKeyPress(event) {
                var k = event.which || event.keyCode;
                if(k == 67){
                    currentPathtype="circle";
                }
                else if(k == 72){
                    currentPathtype="hline";
                }
                else if(k == 86){
                    currentPathtype="vline";
                }
                else if(k == 85){
                    temp = voronoiMap.pop(); 
                    scene.remove(temp.cone);
                    scene.remove(temp.sphere);
                }
                else{
                    alert("Invalid Key!!!\n\nMouseDown to add new particles to the canvus\nPress 'u' to undo\nPress 'c' to change subsequent particle paths to circles\nPress 'h' to change subsequent particle paths to horizontal lines\nPress 'v' to change subsequent particle paths to vertical lines"); 
                }
            }

            function voronoiCell(pathtype, cx, cy, speed = 5, size = 50) {
                //the black sphere represents the location for the voronoi cell
                var geometry = new THREE.SphereGeometry( 3, 32, 32 );
                var material = new THREE.MeshBasicMaterial( {color: 0x000000} );
                this.sphere = new THREE.Mesh( geometry, material );
                this.sphere.position.x = cx;
                this.sphere.position.y = cy;
                this.sphere.position.z = 198;
                //the cone represents the voronoi cell
                var mat = new THREE.MeshBasicMaterial({color: '#'+Math.floor(Math.random()*16777215).toString(16)});
                this.cone = new THREE.Mesh(new THREE.CylinderGeometry(0, 1400, 400, 50, 50, false), mat);
                this.cone.rotation.x += Math.PI/2;
                this.cone.position.x = cx;
                this.cone.position.y = cy;
                this.cone.overdraw = true;
                //other attributes used to keep move the location along a path
                this.starttime = (new Date()).getTime();
                this.pathtype = pathtype;
                this.speed = speed;
                this.size = size;
                this.cx = cx;
                this.cy = cy;
            }

            voronoiCell.prototype.update = function(timer){
                if(this.pathtype == "circle"){
                    this.cone.position.x = this.cx + Math.cos( this.starttime + timer * this.speed ) * this.size;
                    this.cone.position.y = this.cy + Math.sin( this.starttime + timer * this.speed ) * this.size;
                    this.sphere.position.x = this.cone.position.x;
                    this.sphere.position.y = this.cone.position.y;
                }
                else if(this.pathtype == "hline"){
                    this.cone.position.x = this.cx + Math.cos( this.starttime + timer * this.speed ) * this.size;
                    this.sphere.position.x = this.cone.position.x;
                }
                else if(this.pathtype == "vline"){
                    this.cone.position.y = this.cy + Math.sin( this.starttime + timer * this.speed ) * this.size;
                    this.sphere.position.y = this.cone.position.y;
                }
            };

            </script>
        </body>
    </html>      
